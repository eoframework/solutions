---
# backup.yml - Configuration backup playbook
# Creates timestamped backups of SRX configurations

- name: Backup SRX Configurations
  hosts: srx_firewalls
  gather_facts: no
  connection: netconf

  vars:
    backup_dir: "{{ playbook_dir }}/../backups"
    backup_timestamp: "{{ lookup('pipe', 'date +%Y%m%d_%H%M%S') }}"

  tasks:
    - name: Ensure backup directory exists
      ansible.builtin.file:
        path: "{{ backup_dir }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      run_once: true

    - name: Backup current configuration
      junipernetworks.junos.junos_config:
        backup: yes
        backup_options:
          filename: "{{ inventory_hostname }}_{{ backup_timestamp }}.conf"
          dir_path: "{{ backup_dir }}"
      register: backup_result

    - name: Get configuration in set format
      junipernetworks.junos.junos_command:
        commands:
          - show configuration | display set
        display: text
      register: config_set

    - name: Save set-format configuration
      ansible.builtin.copy:
        content: "{{ config_set.stdout[0] }}"
        dest: "{{ backup_dir }}/{{ inventory_hostname }}_{{ backup_timestamp }}_set.conf"
        mode: '0644'
      delegate_to: localhost

    - name: Get rescue configuration
      junipernetworks.junos.junos_command:
        commands:
          - show system configuration rescue
        display: text
      register: rescue_config
      ignore_errors: yes

    - name: Display backup summary
      ansible.builtin.debug:
        msg: >
          Backup completed for {{ inventory_hostname }}
          Files saved to: {{ backup_dir }}

    - name: Cleanup old backups (keep last 30)
      ansible.builtin.shell: |
        cd {{ backup_dir }} && ls -t {{ inventory_hostname }}_*.conf | tail -n +31 | xargs -r rm
      delegate_to: localhost
      changed_when: false
      ignore_errors: yes
