---
#------------------------------------------------------------------------------
# Role: gitlab-setup
# Purpose: Configure GitLab for network automation CI/CD
#------------------------------------------------------------------------------

- name: Verify GitLab connectivity
  ansible.builtin.uri:
    url: "{{ gitlab.url }}/api/v4/version"
    method: GET
    headers:
      PRIVATE-TOKEN: "{{ vault_gitlab_api_token }}"
    validate_certs: true
    status_code: 200
    timeout: 30
  register: gitlab_version

- name: Display GitLab version
  ansible.builtin.debug:
    msg: "Connected to GitLab {{ gitlab_version.json.version }}"

- name: Create automation group variables
  ansible.builtin.uri:
    url: "{{ gitlab.url }}/api/v4/groups/{{ gitlab_group_id }}/variables"
    method: POST
    headers:
      PRIVATE-TOKEN: "{{ vault_gitlab_api_token }}"
    body_format: json
    body:
      key: "{{ item.key }}"
      value: "{{ item.value }}"
      protected: "{{ item.protected | default(false) }}"
      masked: "{{ item.masked | default(false) }}"
    validate_certs: true
    status_code: [201, 400]  # 400 if already exists
    timeout: 30
  loop:
    - { key: "DNAC_HOST", value: "{{ dnac.hostname }}", protected: true }
    - { key: "NSO_HOST", value: "{{ nso.hostname }}", protected: true }
    - { key: "ANSIBLE_VAULT_ID", value: "{{ ansible.vault_id }}", protected: true }
  when: gitlab_group_id is defined
  no_log: true
  ignore_errors: yes

- name: Configure GitLab runner for Cisco automation
  ansible.builtin.uri:
    url: "{{ gitlab.url }}/api/v4/runners"
    method: GET
    headers:
      PRIVATE-TOKEN: "{{ vault_gitlab_api_token }}"
    body_format: json
    body:
      tag_list: "{{ gitlab.runner_tag }}"
    validate_certs: true
    status_code: 200
    timeout: 30
  register: gitlab_runners

- name: Verify runner availability
  ansible.builtin.assert:
    that:
      - gitlab_runners.json | length > 0
    fail_msg: "No runners found with tag '{{ gitlab.runner_tag }}'"
    success_msg: "Found {{ gitlab_runners.json | length }} runner(s) with tag '{{ gitlab.runner_tag }}'"

- name: Create .gitlab-ci.yml template for network automation
  ansible.builtin.set_fact:
    gitlab_ci_template: |
      ---
      # Cisco Network Automation CI/CD Pipeline
      # Auto-generated by EO Framework

      stages:
        - validate
        - plan
        - deploy
        - verify

      variables:
        ANSIBLE_FORCE_COLOR: "true"
        ANSIBLE_VAULT_PASSWORD_FILE: "$CI_PROJECT_DIR/.vault_pass"

      .cisco_automation:
        tags:
          - {{ gitlab.runner_tag }}
        before_script:
          - ansible-galaxy collection install -r requirements.yml
          - echo "$ANSIBLE_VAULT_PASSWORD" > .vault_pass

      validate:
        extends: .cisco_automation
        stage: validate
        script:
          - ansible-lint playbooks/
          - ansible-playbook --syntax-check playbooks/site.yml

      plan:
        extends: .cisco_automation
        stage: plan
        script:
          - ansible-playbook playbooks/site.yml --check --diff
        rules:
          - if: $CI_COMMIT_BRANCH == "main"
            when: manual

      deploy:
        extends: .cisco_automation
        stage: deploy
        script:
          - ansible-playbook playbooks/site.yml
        rules:
          - if: $CI_COMMIT_BRANCH == "main"
            when: manual
        environment:
          name: production

      verify:
        extends: .cisco_automation
        stage: verify
        script:
          - ansible-playbook playbooks/05-validation.yml
        needs: [deploy]

- name: GitLab setup complete
  ansible.builtin.debug:
    msg: "GitLab CI/CD configuration completed successfully"
