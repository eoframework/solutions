---
#------------------------------------------------------------------------------
# Role: jenkins-setup
# Purpose: Configure Jenkins for network automation CI/CD
#------------------------------------------------------------------------------

- name: Verify Jenkins connectivity
  ansible.builtin.uri:
    url: "{{ jenkins.url }}/api/json"
    method: GET
    user: "{{ jenkins.admin_user }}"
    password: "{{ vault_jenkins_admin_password }}"
    force_basic_auth: yes
    validate_certs: true
    status_code: 200
    timeout: 30
  register: jenkins_info

- name: Display Jenkins version
  ansible.builtin.debug:
    msg: "Connected to Jenkins {{ jenkins_info.json.nodeDescription | default('N/A') }}"

- name: Check for required plugins
  ansible.builtin.uri:
    url: "{{ jenkins.url }}/pluginManager/api/json?depth=1"
    method: GET
    user: "{{ jenkins.admin_user }}"
    password: "{{ vault_jenkins_admin_password }}"
    force_basic_auth: yes
    validate_certs: true
    status_code: 200
    timeout: 30
  register: jenkins_plugins

- name: Verify required plugins installed
  ansible.builtin.assert:
    that:
      - "'ansible' in jenkins_plugins.json.plugins | map(attribute='shortName') | list"
    fail_msg: "Required plugin 'ansible' not installed"
    success_msg: "Required Jenkins plugins are installed"
  ignore_errors: yes

- name: Configure Jenkins credentials for DNAC
  ansible.builtin.uri:
    url: "{{ jenkins.url }}/credentials/store/system/domain/_/createCredentials"
    method: POST
    user: "{{ jenkins.admin_user }}"
    password: "{{ vault_jenkins_admin_password }}"
    force_basic_auth: yes
    body_format: form-urlencoded
    body:
      json: |
        {
          "": "0",
          "credentials": {
            "scope": "GLOBAL",
            "id": "dnac-credentials",
            "username": "{{ dnac.admin_user }}",
            "password": "{{ vault_dnac_admin_password }}",
            "description": "DNA Center API credentials",
            "$class": "com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl"
          }
        }
    validate_certs: true
    status_code: [200, 302, 409]  # 409 if exists
    timeout: 30
  no_log: true
  ignore_errors: yes

- name: Configure Jenkins shared library
  ansible.builtin.uri:
    url: "{{ jenkins.url }}/job/{{ jenkins.shared_lib }}/api/json"
    method: GET
    user: "{{ jenkins.admin_user }}"
    password: "{{ vault_jenkins_admin_password }}"
    force_basic_auth: yes
    validate_certs: true
    status_code: [200, 404]
    timeout: 30
  register: shared_lib_check

- name: Display shared library status
  ansible.builtin.debug:
    msg: >-
      Shared library '{{ jenkins.shared_lib }}':
      {{ 'EXISTS' if shared_lib_check.status == 200 else 'NOT FOUND - Manual setup required' }}

- name: Create Jenkinsfile template for network automation
  ansible.builtin.set_fact:
    jenkinsfile_template: |
      // Cisco Network Automation Pipeline
      // Auto-generated by EO Framework

      @Library('{{ jenkins.shared_lib }}') _

      pipeline {
          agent {
              label 'cisco-automation'
          }

          environment {
              DNAC_CREDENTIALS = credentials('dnac-credentials')
              NSO_CREDENTIALS = credentials('nso-credentials')
              ANSIBLE_VAULT_PASSWORD = credentials('ansible-vault-password')
          }

          stages {
              stage('Validate') {
                  steps {
                      sh 'ansible-lint playbooks/'
                      sh 'ansible-playbook --syntax-check playbooks/site.yml'
                  }
              }

              stage('Plan') {
                  steps {
                      sh 'ansible-playbook playbooks/site.yml --check --diff'
                  }
              }

              stage('Deploy') {
                  when {
                      branch 'main'
                  }
                  input {
                      message "Deploy to production?"
                      ok "Deploy"
                  }
                  steps {
                      sh 'ansible-playbook playbooks/site.yml'
                  }
              }

              stage('Verify') {
                  steps {
                      sh 'ansible-playbook playbooks/05-validation.yml'
                  }
              }
          }

          post {
              always {
                  archiveArtifacts artifacts: 'logs/**', allowEmptyArchive: true
              }
              failure {
                  slackSend channel: '{{ notifications.slack_channel }}',
                            message: "Pipeline failed: ${env.JOB_NAME} #${env.BUILD_NUMBER}"
              }
          }
      }

- name: Jenkins setup complete
  ansible.builtin.debug:
    msg: "Jenkins CI/CD configuration completed successfully"
