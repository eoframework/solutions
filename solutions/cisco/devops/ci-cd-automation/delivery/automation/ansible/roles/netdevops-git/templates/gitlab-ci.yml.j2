# GitLab CI/CD Pipeline for Cisco Network Automation
# Generated by NetDevOps Git role

stages:
  - validate
  - test
  - deploy

variables:
  ANSIBLE_FORCE_COLOR: "true"
  ANSIBLE_HOST_KEY_CHECKING: "false"

# Syntax validation stage
validate:syntax:
  stage: validate
  tags:
    - {{ gitlab_runner_tag | default('cisco-automation') }}
  script:
    - echo "Validating Ansible syntax..."
    - ansible-playbook --syntax-check playbooks/*.yml
    - echo "Validating YAML files..."
    - find . -name "*.yml" -o -name "*.yaml" | xargs yamllint
  only:
    - merge_requests
    - main

# Linting stage
validate:lint:
  stage: validate
  tags:
    - {{ gitlab_runner_tag | default('cisco-automation') }}
  script:
    - echo "Running Ansible lint..."
    - ansible-lint playbooks/*.yml
  allow_failure: true
  only:
    - merge_requests
    - main

# Test in lab environment
test:lab:
  stage: test
  tags:
    - {{ gitlab_runner_tag | default('cisco-automation') }}
  script:
    - echo "Testing in lab environment..."
    - ansible-playbook -i inventory/test/hosts.yml playbooks/validation.yml --check
  only:
    - merge_requests
  when: manual

# Deploy to production
deploy:production:
  stage: deploy
  tags:
    - {{ gitlab_runner_tag | default('cisco-automation') }}
  script:
    - echo "Deploying to production..."
    - ansible-playbook -i inventory/prod/hosts.yml playbooks/site.yml
  only:
    - main
  when: manual
  environment:
    name: production
