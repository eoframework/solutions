---
#------------------------------------------------------------------------------
# Phase 1: Discovery - Device Discovery and Inventory
#------------------------------------------------------------------------------
# This playbook handles device discovery including:
#   - IP range discovery
#   - Device inventory collection
#   - Device assignment to sites
#------------------------------------------------------------------------------

- name: Phase 1 - Device Discovery
  hosts: localhost
  gather_facts: no
  tags: [discovery]

  vars_files:
    - "{{ playbook_dir }}/../vars/generated/project.yml"
    - "{{ playbook_dir }}/../vars/generated/dnac.yml"
    - "{{ playbook_dir }}/../vars/generated/deployment.yml"
    - "{{ playbook_dir }}/../vars/generated/devices.yml"
    - "{{ playbook_dir }}/../vars/secrets.yml"

  tasks:
    #--------------------------------------------------------------------------
    # Authentication
    #--------------------------------------------------------------------------
    - name: Authenticate to DNA Center
      cisco.dnac.dnac_auth:
        dnac_host: "{{ dnac.vip }}"
        dnac_username: "{{ dnac.admin_user }}"
        dnac_password: "{{ vault_dnac_admin_password }}"
        dnac_verify: "{{ dnac.ssl_verify }}"
      register: dnac_auth

    #--------------------------------------------------------------------------
    # Discovery Jobs
    #--------------------------------------------------------------------------
    - name: Get existing discovery jobs
      cisco.dnac.discovery_info:
        dnac_host: "{{ dnac.vip }}"
        dnac_auth: "{{ dnac_auth.dnac_auth }}"
      register: existing_discoveries

    - name: Display existing discoveries
      ansible.builtin.debug:
        var: existing_discoveries
        verbosity: 1

    #--------------------------------------------------------------------------
    # Note: Discovery configuration would typically be done via UI or API
    # This is a placeholder for discovery automation
    #--------------------------------------------------------------------------
    - name: Discovery placeholder
      ansible.builtin.debug:
        msg: |
          ============================================================
          Device Discovery
          ============================================================
          To discover devices, configure discovery jobs in DNA Center:

          1. Go to Tools > Discovery
          2. Create new discovery using:
             - IP Range: Based on your network design
             - Credentials: Use credentials created in Phase 1
             - SNMP: {{ devices.snmp_version }}
             - NETCONF Port: {{ devices.netconf_port }}

          Target Devices:
          - Pilot: {{ deployment.pilot_device_count }}
          - Production: {{ deployment.production_device_count }}
          ============================================================

    #--------------------------------------------------------------------------
    # Get Discovered Devices
    #--------------------------------------------------------------------------
    - name: Get all network devices
      cisco.dnac.network_device_info:
        dnac_host: "{{ dnac.vip }}"
        dnac_auth: "{{ dnac_auth.dnac_auth }}"
      register: all_devices

    - name: Display discovered device count
      ansible.builtin.debug:
        msg: "Discovered {{ all_devices.dnac_response | length }} devices"

    #--------------------------------------------------------------------------
    # Device Health Check
    #--------------------------------------------------------------------------
    - name: Get device health
      ansible.builtin.uri:
        url: "https://{{ dnac.vip }}/dna/intent/api/v1/device-health"
        method: GET
        headers:
          x-auth-token: "{{ dnac_auth.dnac_auth }}"
        validate_certs: "{{ dnac.ssl_verify }}"
      register: device_health

    - name: Discovery summary
      ansible.builtin.debug:
        msg: |
          ============================================================
          Phase 1 - Discovery Complete
          ============================================================
          Total Devices: {{ all_devices.dnac_response | length }}
          Target (Pilot): {{ deployment.pilot_device_count }}
          Target (Production): {{ deployment.production_device_count }}
          ============================================================
