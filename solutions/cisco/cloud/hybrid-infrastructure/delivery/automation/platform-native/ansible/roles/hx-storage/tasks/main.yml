---
#------------------------------------------------------------------------------
# Role: hx-storage
# Purpose: Configure HyperFlex datastores and storage policies
#------------------------------------------------------------------------------

- name: Get HyperFlex cluster storage status
  ansible.builtin.uri:
    url: "https://{{ hyperflex.mgmt_ip }}/coreapi/v1/clusters/{{ hyperflex.cluster_uuid }}/storage"
    method: GET
    headers:
      Authorization: "Bearer {{ hx_auth_token }}"
    validate_certs: "{{ hyperflex.ssl_verify | default(false) }}"
    status_code: [200]
  register: storage_status
  when: hx_auth_token is defined

- name: Display storage capacity
  ansible.builtin.debug:
    msg: |
      HyperFlex Storage Status:
      - Usable Capacity: {{ hyperflex.usable_capacity_tb }} TB
      - Replication Factor: {{ hyperflex.replication_factor }}
      - Deduplication: {{ hyperflex.dedup_enabled }}
      - Compression: {{ hyperflex.compression_enabled }}

- name: Configure primary datastore via vSphere
  community.vmware.vmware_datastore_info:
    hostname: "{{ vmware.vcenter_fqdn }}"
    username: "{{ vmware.vcenter_admin_user }}"
    password: "{{ vault_vcenter_admin_password }}"
    validate_certs: "{{ vmware.ssl_verify | default(false) }}"
    datacenter: "{{ vmware.datacenter_name | default('Datacenter') }}"
  register: datastore_info

- name: Display datastore information
  ansible.builtin.debug:
    msg: |
      Available Datastores:
      {% for ds in datastore_info.datastores %}
      - {{ ds.name }}: {{ (ds.capacity / 1099511627776) | round(2) }} TB ({{ ds.type }})
      {% endfor %}
  when: datastore_info.datastores | length > 0

- name: Configure storage policies via Intersight
  cisco.intersight.intersight_rest_api:
    api_private_key: "{{ vault_intersight_api_key }}"
    api_key_id: "{{ intersight.api_key_id }}"
    api_uri: /hyperflex/StorageContainers
    query_params:
      $filter: "ClusterUuid eq '{{ hyperflex.cluster_uuid }}'"
  register: storage_containers
  when: hyperflex.cluster_uuid is defined

- name: Configure backup datastore for Veeam
  community.vmware.vmware_datastore_info:
    hostname: "{{ vmware.vcenter_fqdn }}"
    username: "{{ vmware.vcenter_admin_user }}"
    password: "{{ vault_vcenter_admin_password }}"
    validate_certs: "{{ vmware.ssl_verify | default(false) }}"
    datacenter: "{{ vmware.datacenter_name | default('Datacenter') }}"
    name: "{{ backup.datastore_name | default('Backup-Datastore') }}"
  register: backup_datastore
  when: backup.veeam_server_ip is defined
  failed_when: false

- name: Display storage configuration summary
  ansible.builtin.debug:
    msg: |
      ============================================================
      Storage Configuration Complete
      ============================================================
      Cluster: {{ hyperflex.cluster_name }}
      Primary Datastore: Configured
      Backup Target: {{ backup.veeam_server_ip | default('Not configured') }}
      ============================================================
