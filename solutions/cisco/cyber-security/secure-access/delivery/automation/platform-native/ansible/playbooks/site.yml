---
#------------------------------------------------------------------------------
# Cisco ISE Secure Access - Master Playbook
#------------------------------------------------------------------------------
# This is the main orchestration playbook that imports all phase playbooks.
#
# Usage:
#   Full deployment:   ansible-playbook playbooks/site.yml
#   Specific phase:    ansible-playbook playbooks/01-foundation.yml
#   With vault:        ansible-playbook playbooks/site.yml --ask-vault-pass
#
# Tags:
#   foundation     - Phase 1: ISE cluster setup and certificates
#   identity       - Phase 1: Identity sources (AD, LDAP)
#   policies       - Phase 2: Authorization and authentication policies
#   integration    - Phase 2: External integrations (Duo, Umbrella, SecureX)
#   validation     - Phase 3: Go-live validation and testing
#------------------------------------------------------------------------------

- name: ISE Secure Access - Full Deployment
  hosts: localhost
  gather_facts: no

  vars_files:
    - "{{ playbook_dir }}/../vars/generated/project.yml"
    - "{{ playbook_dir }}/../vars/generated/ise.yml"
    - "{{ playbook_dir }}/../vars/secrets.yml"

  pre_tasks:
    - name: Display deployment information
      ansible.builtin.debug:
        msg: |
          ============================================================
          Cisco ISE Secure Access Deployment
          ============================================================
          Solution: {{ solution.name }}
          ISE Primary: {{ ise.fqdn }} ({{ ise.primary_ip }})
          ISE Version: {{ ise.version }}
          Deployment Type: {{ deployment.type }}
          ============================================================

    - name: Verify ISE connectivity
      ansible.builtin.uri:
        url: "https://{{ ise.primary_ip }}/ers/config/node"
        method: GET
        user: "{{ ise.admin_user }}"
        password: "{{ vault_ise_admin_password }}"
        force_basic_auth: yes
        validate_certs: "{{ ise.ssl_verify }}"
        headers:
          Accept: application/json
        status_code: [200, 401]
      register: ise_connectivity
      tags: [always]

- name: Phase 1 - Foundation
  ansible.builtin.import_playbook: 01-foundation.yml
  tags: [foundation]

- name: Phase 1 - Identity Sources
  ansible.builtin.import_playbook: 02-identity.yml
  tags: [identity]

- name: Phase 2 - Policies
  ansible.builtin.import_playbook: 03-policies.yml
  tags: [policies]

- name: Phase 2 - Integration
  ansible.builtin.import_playbook: 04-integration.yml
  tags: [integration]

- name: Phase 3 - Validation
  ansible.builtin.import_playbook: 05-validation.yml
  tags: [validation]
