---
#------------------------------------------------------------------------------
# Phase 3: Validation - Go-Live Validation and Testing
#------------------------------------------------------------------------------
# This playbook handles validation including:
#   - ISE cluster health
#   - Policy verification
#   - Integration testing
#   - Reporting
#------------------------------------------------------------------------------

- name: Phase 3 - Go-Live Validation
  hosts: localhost
  gather_facts: no
  tags: [validation]

  vars_files:
    - "{{ playbook_dir }}/../vars/generated/project.yml"
    - "{{ playbook_dir }}/../vars/generated/ise.yml"
    - "{{ playbook_dir }}/../vars/generated/deployment.yml"
    - "{{ playbook_dir }}/../vars/generated/duo.yml"
    - "{{ playbook_dir }}/../vars/generated/umbrella.yml"
    - "{{ playbook_dir }}/../vars/generated/securex.yml"
    - "{{ playbook_dir }}/../vars/secrets.yml"

  tasks:
    #--------------------------------------------------------------------------
    # ISE Cluster Health
    #--------------------------------------------------------------------------
    - name: Check ISE node status
      ansible.builtin.uri:
        url: "https://{{ ise.primary_ip }}/ers/config/node"
        method: GET
        user: "{{ ise.admin_user }}"
        password: "{{ vault_ise_admin_password }}"
        force_basic_auth: yes
        validate_certs: "{{ ise.ssl_verify }}"
        headers:
          Accept: application/json
      register: ise_nodes

    - name: Display ISE cluster status
      ansible.builtin.debug:
        msg: "ISE Nodes: {{ ise_nodes.json | default('Check response') }}"
        verbosity: 1

    #--------------------------------------------------------------------------
    # Network Device Count
    #--------------------------------------------------------------------------
    - name: Get network device count
      ansible.builtin.uri:
        url: "https://{{ ise.primary_ip }}/ers/config/networkdevice"
        method: GET
        user: "{{ ise.admin_user }}"
        password: "{{ vault_ise_admin_password }}"
        force_basic_auth: yes
        validate_certs: "{{ ise.ssl_verify }}"
        headers:
          Accept: application/json
      register: network_devices

    - name: Validate network device count
      ansible.builtin.debug:
        msg: |
          Network Devices:
          - Registered: {{ network_devices.json.SearchResult.total | default('N/A') }}
          - Target: {{ deployment.nad_count }}

    #--------------------------------------------------------------------------
    # Endpoint Count
    #--------------------------------------------------------------------------
    - name: Get endpoint count
      ansible.builtin.uri:
        url: "https://{{ ise.primary_ip }}/ers/config/endpoint"
        method: GET
        user: "{{ ise.admin_user }}"
        password: "{{ vault_ise_admin_password }}"
        force_basic_auth: yes
        validate_certs: "{{ ise.ssl_verify }}"
        headers:
          Accept: application/json
      register: endpoints

    - name: Display endpoint summary
      ansible.builtin.debug:
        msg: |
          Endpoints:
          - Registered: {{ endpoints.json.SearchResult.total | default('N/A') }}
          - Target: {{ deployment.endpoint_target }}

    #--------------------------------------------------------------------------
    # Service Status
    #--------------------------------------------------------------------------
    - name: Check ISE service status
      ansible.builtin.debug:
        msg: |
          Service Status Check:
          - RADIUS Service: Verify port {{ ise.radius_auth_port }} is responding
          - TACACS+ Service: Verify port {{ ise.tacacs_port }} is responding
          - ERS API: Verified (used for this validation)

          Manual Verification:
          ssh admin@{{ ise.primary_ip }}
          show application status ise

    #--------------------------------------------------------------------------
    # Validation Report
    #--------------------------------------------------------------------------
    - name: Generate validation report
      ansible.builtin.set_fact:
        validation_report: |
          ============================================================
          CISCO ISE SECURE ACCESS - VALIDATION REPORT
          ============================================================
          Date: {{ lookup('pipe', 'date -Iseconds') }}
          Solution: {{ solution.name }}
          ISE Primary: {{ ise.fqdn }} ({{ ise.primary_ip }})
          ISE Version: {{ ise.version }}

          CLUSTER SUMMARY
          ----------------
          Primary Node: {{ ise.primary_ip }}
          Secondary Node: {{ ise.secondary_ip }}
          Deployment Type: {{ deployment.type }}

          DEVICE SUMMARY
          --------------
          Network Devices (NAD): {{ network_devices.json.SearchResult.total | default('N/A') }}
          Endpoints: {{ endpoints.json.SearchResult.total | default('N/A') }}
          Target NADs: {{ deployment.nad_count }}
          Target Endpoints: {{ deployment.endpoint_target }}

          INTEGRATION STATUS
          ------------------
          Active Directory: {{ integrations.ad_domain | default('Configured') }}
          Duo MFA: {{ 'Enabled' if duo.enabled else 'Disabled' }}
          Umbrella: {{ 'Enabled' if umbrella.enabled else 'Disabled' }}
          SecureX: {{ 'Enabled' if securex.enabled else 'Disabled' }}

          SERVICE PORTS
          -------------
          RADIUS Auth: {{ ise.radius_auth_port }}
          RADIUS Acct: {{ ise.radius_acct_port }}
          TACACS+: {{ ise.tacacs_port }}

          VALIDATION STATUS: REVIEW REQUIRED
          ============================================================

    - name: Display validation report
      ansible.builtin.debug:
        msg: "{{ validation_report }}"

    - name: Save validation report to file
      ansible.builtin.copy:
        content: "{{ validation_report }}"
        dest: "{{ playbook_dir }}/../logs/validation_report_{{ lookup('pipe', 'date +%Y%m%d_%H%M%S') }}.txt"
      delegate_to: localhost
