#------------------------------------------------------------------------------
# Slurm Configuration - Generated by Ansible
# DGX SuperPOD Cluster: {{ cluster.name }}
#------------------------------------------------------------------------------

#------------------------------------------------------------------------------
# Cluster Identity
#------------------------------------------------------------------------------
ClusterName={{ cluster.name }}
SlurmctldHost={{ slurm.controller_ip }}
{% if slurm.controller_backup_ip is defined and slurm.controller_backup_ip %}
SlurmctldHost={{ slurm.controller_backup_ip }}(backup)
{% endif %}

#------------------------------------------------------------------------------
# Control Daemon Configuration
#------------------------------------------------------------------------------
SlurmctldPort=6817
SlurmdPort=6818
SlurmctldPidFile=/var/run/slurmctld.pid
SlurmdPidFile=/var/run/slurmd.pid
SlurmdSpoolDir=/var/spool/slurm/d
StateSaveLocation=/var/spool/slurm/ctld
SlurmUser=slurm
SlurmdUser=root

#------------------------------------------------------------------------------
# Authentication
#------------------------------------------------------------------------------
AuthType=auth/munge
CryptoType=crypto/munge

#------------------------------------------------------------------------------
# Logging
#------------------------------------------------------------------------------
SlurmctldDebug=info
SlurmctldLogFile=/var/log/slurm/slurmctld.log
SlurmdDebug=info
SlurmdLogFile=/var/log/slurm/slurmd.log

#------------------------------------------------------------------------------
# Process Tracking and Resource Management
#------------------------------------------------------------------------------
ProctrackType=proctrack/cgroup
TaskPlugin=task/cgroup,task/affinity
SelectType=select/cons_tres
SelectTypeParameters=CR_Core_Memory

#------------------------------------------------------------------------------
# GPU Configuration (GRES)
#------------------------------------------------------------------------------
GresTypes=gpu
AccountingStorageTRES=gres/gpu

#------------------------------------------------------------------------------
# Job Scheduling
#------------------------------------------------------------------------------
SchedulerType=sched/backfill
{% if slurm.fairshare_enabled %}
PriorityType=priority/multifactor
PriorityDecayHalfLife=7-0
PriorityFavorSmall=NO
PriorityWeightAge=1000
PriorityWeightFairshare=10000
PriorityWeightJobSize=500
PriorityWeightPartition=1000
{% else %}
PriorityType=priority/basic
{% endif %}

#------------------------------------------------------------------------------
# Job Preemption
#------------------------------------------------------------------------------
PreemptType=preempt/partition_prio
PreemptMode=REQUEUE

#------------------------------------------------------------------------------
# Resource Limits
#------------------------------------------------------------------------------
DefMemPerCPU=8192
MaxMemPerCPU=16384
MaxJobCount=100000
MaxArraySize=10000

#------------------------------------------------------------------------------
# Job Scripts
#------------------------------------------------------------------------------
Prolog=/etc/slurm/prolog.sh
Epilog=/etc/slurm/epilog.sh
HealthCheckProgram=/etc/slurm/healthcheck.sh
HealthCheckInterval=300

#------------------------------------------------------------------------------
# Accounting
#------------------------------------------------------------------------------
AccountingStorageType=accounting_storage/slurmdbd
AccountingStorageHost={{ slurm.controller_ip }}
AccountingStoragePort=6819
AccountingStorageEnforce=limits,safe

#------------------------------------------------------------------------------
# Job Completion Logging
#------------------------------------------------------------------------------
JobCompType=jobcomp/none
JobAcctGatherType=jobacct_gather/cgroup
JobAcctGatherFrequency=30

#------------------------------------------------------------------------------
# Partitions
#------------------------------------------------------------------------------
PartitionName={{ slurm.partition_gpu }} Nodes=ALL Default=YES MaxTime={{ slurm.max_job_time_hours }}:00:00 State=UP DefMemPerCPU=8192 OverSubscribe=EXCLUSIVE

#------------------------------------------------------------------------------
# Node Configuration
# Auto-generated based on hardware configuration
#------------------------------------------------------------------------------
# Format: NodeName=<name> CPUs=<count> Boards=1 SocketsPerBoard=<sockets> CoresPerSocket=<cores> ThreadsPerCore=<threads> RealMemory=<mb> Gres=gpu:{{ hardware.gpu_model | lower | replace(' ', '_') }}:{{ hardware.gpu_count_per_node }}
# Example for DGX H100:
# NodeName=dgx-h100-[01-{{ hardware.dgx_node_count }}] CPUs=224 Boards=1 SocketsPerBoard=2 CoresPerSocket=56 ThreadsPerCore=2 RealMemory={{ hardware.system_ram_gb * 1024 }} Gres={{ slurm.gres_config }}
