# Dell Precision AI Workstation - NVIDIA Driver Playbook
# EO Framework - Dell AI Solutions
# GPU driver, CUDA, and cuDNN installation

---
- name: Install NVIDIA Drivers and CUDA
  hosts: ai_workstations
  gather_facts: true
  become: true
  tags: [nvidia, gpu]

  pre_tasks:
    - name: Display GPU configuration
      ansible.builtin.debug:
        msg: |
          Installing NVIDIA drivers on {{ inventory_hostname }}
          GPU Model: {{ hardware.gpu_model }}
          Driver Version: {{ software.nvidia_driver_version }}
          CUDA Version: {{ software.cuda_version }}

  roles:
    #=========================================================================
    # NVIDIA DRIVER AND CUDA
    #=========================================================================
    - role: nvidia-drivers
      tags: [drivers, cuda]

  post_tasks:
    - name: Reboot to load NVIDIA drivers
      ansible.builtin.reboot:
        reboot_timeout: 600

    - name: Wait for workstation to come back online
      ansible.builtin.wait_for_connection:
        timeout: 300

    - name: Verify NVIDIA driver installation
      ansible.builtin.command: nvidia-smi
      register: nvidia_smi_output
      changed_when: false

    - name: Display nvidia-smi output
      ansible.builtin.debug:
        var: nvidia_smi_output.stdout_lines

    - name: Verify CUDA installation
      ansible.builtin.command: nvcc --version
      register: nvcc_output
      changed_when: false

    - name: Display CUDA version
      ansible.builtin.debug:
        var: nvcc_output.stdout_lines
