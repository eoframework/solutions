---
#==============================================================================
# AAP Workflow Templates Configuration
#==============================================================================

- name: Create workflow templates
  ansible.controller.workflow_job_template:
    controller_host: "{{ platform.controller_url }}"
    controller_username: "{{ aap_admin_username }}"
    controller_password: "{{ aap_admin_password }}"
    validate_certs: "{{ aap_validate_certs | default(true) }}"
    name: "{{ item.name }}"
    organization: "{{ item.organization | default(rbac.default_organization) }}"
    description: "{{ item.description | default(omit) }}"
    extra_vars: "{{ item.extra_vars | default(omit) }}"
    survey_enabled: "{{ item.survey_enabled | default(false) }}"
    survey_spec: "{{ item.survey_spec | default(omit) }}"
    ask_variables_on_launch: "{{ item.ask_variables_on_launch | default(false) }}"
    ask_inventory_on_launch: "{{ item.ask_inventory_on_launch | default(false) }}"
    ask_limit_on_launch: "{{ item.ask_limit_on_launch | default(false) }}"
    allow_simultaneous: "{{ item.allow_simultaneous | default(false) }}"
    state: present
  loop: "{{ aap_workflow_templates }}"

- name: Create workflow nodes
  ansible.controller.workflow_job_template_node:
    controller_host: "{{ platform.controller_url }}"
    controller_username: "{{ aap_admin_username }}"
    controller_password: "{{ aap_admin_password }}"
    validate_certs: "{{ aap_validate_certs | default(true) }}"
    workflow_job_template: "{{ item.workflow }}"
    identifier: "{{ item.identifier }}"
    unified_job_template: "{{ item.job_template | default(omit) }}"
    approval_node: "{{ item.approval_node | default(omit) }}"
    inventory: "{{ item.inventory | default(omit) }}"
    limit: "{{ item.limit | default(omit) }}"
    job_tags: "{{ item.job_tags | default(omit) }}"
    skip_tags: "{{ item.skip_tags | default(omit) }}"
    extra_data: "{{ item.extra_data | default(omit) }}"
    all_parents_must_converge: "{{ item.all_parents_must_converge | default(false) }}"
    state: present
  loop: "{{ aap_workflow_nodes | default([]) }}"

- name: Link workflow nodes - success
  ansible.controller.workflow_job_template_node:
    controller_host: "{{ platform.controller_url }}"
    controller_username: "{{ aap_admin_username }}"
    controller_password: "{{ aap_admin_password }}"
    validate_certs: "{{ aap_validate_certs | default(true) }}"
    workflow_job_template: "{{ item.workflow }}"
    identifier: "{{ item.identifier }}"
    success_nodes: "{{ item.success_nodes | default(omit) }}"
    failure_nodes: "{{ item.failure_nodes | default(omit) }}"
    always_nodes: "{{ item.always_nodes | default(omit) }}"
    state: present
  loop: "{{ aap_workflow_nodes | default([]) }}"
  when: item.success_nodes is defined or item.failure_nodes is defined or item.always_nodes is defined
