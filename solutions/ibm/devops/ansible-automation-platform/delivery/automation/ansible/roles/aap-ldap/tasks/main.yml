---
#==============================================================================
# AAP LDAP Authentication Configuration
#==============================================================================

- name: Configure LDAP authentication
  ansible.controller.settings:
    controller_host: "{{ platform.controller_url }}"
    controller_username: "{{ aap_admin_username }}"
    controller_password: "{{ aap_admin_password }}"
    validate_certs: "{{ aap_validate_certs | default(true) }}"
    settings:
      AUTH_LDAP_SERVER_URI: "{{ auth.ldap_url }}"
      AUTH_LDAP_BIND_DN: "{{ auth.ldap_bind_dn }}"
      AUTH_LDAP_BIND_PASSWORD: "{{ aap_ldap_bind_password }}"
      AUTH_LDAP_START_TLS: "{{ aap_ldap_start_tls | default(true) }}"
      AUTH_LDAP_USER_SEARCH:
        - "{{ auth.ldap_user_search_base }}"
        - "SCOPE_SUBTREE"
        - "{{ aap_ldap_user_filter | default('(uid=%(user)s)') }}"
      AUTH_LDAP_GROUP_SEARCH:
        - "{{ auth.ldap_group_search_base }}"
        - "SCOPE_SUBTREE"
        - "{{ aap_ldap_group_filter | default('(objectClass=groupOfNames)') }}"
      AUTH_LDAP_GROUP_TYPE: "{{ aap_ldap_group_type | default('GroupOfNamesType') }}"
      AUTH_LDAP_USER_ATTR_MAP:
        first_name: "{{ aap_ldap_first_name_attr | default('givenName') }}"
        last_name: "{{ aap_ldap_last_name_attr | default('sn') }}"
        email: "{{ aap_ldap_email_attr | default('mail') }}"
      AUTH_LDAP_USER_FLAGS_BY_GROUP: "{{ aap_ldap_user_flags | default({}) }}"
      AUTH_LDAP_ORGANIZATION_MAP: "{{ aap_ldap_organization_map | default({}) }}"
      AUTH_LDAP_TEAM_MAP: "{{ aap_ldap_team_map | default({}) }}"
  no_log: true

- name: Configure LDAP team mapping
  ansible.controller.settings:
    controller_host: "{{ platform.controller_url }}"
    controller_username: "{{ aap_admin_username }}"
    controller_password: "{{ aap_admin_password }}"
    validate_certs: "{{ aap_validate_certs | default(true) }}"
    settings:
      AUTH_LDAP_TEAM_MAP:
        "{{ rbac.admin_team }}":
          organization: "{{ rbac.default_organization }}"
          users: "{{ aap_ldap_admin_groups | default([]) }}"
          remove: true
        "{{ rbac.operator_team }}":
          organization: "{{ rbac.default_organization }}"
          users: "{{ aap_ldap_operator_groups | default([]) }}"
          remove: true
        "{{ rbac.auditor_team }}":
          organization: "{{ rbac.default_organization }}"
          users: "{{ aap_ldap_auditor_groups | default([]) }}"
          remove: true
  when: aap_ldap_team_mapping_enabled | default(true)
