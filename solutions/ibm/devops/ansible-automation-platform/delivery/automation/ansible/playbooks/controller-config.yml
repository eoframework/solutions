---
# Ansible Automation Platform Controller Configuration
# Configures organizations, credentials, projects, and job templates
#
# Usage:
#   ansible-playbook -i inventory/prod playbooks/controller-config.yml
#
# Prerequisites:
#   - AAP Controller deployed and accessible
#   - Controller admin credentials available
#   - awx.awx collection installed

- name: Configure Automation Controller
  hosts: localhost
  gather_facts: false
  connection: local

  vars_files:
    - "{{ playbook_dir }}/../inventory/{{ env | default('prod') }}/group_vars/all.yml"

  vars:
    controller_host: "{{ aap_controller_url }}"
    controller_username: "{{ lookup('env', 'CONTROLLER_USERNAME') | default('admin') }}"
    controller_password: "{{ lookup('env', 'CONTROLLER_PASSWORD') }}"
    validate_certs: false

  tasks:
    #==========================================================================
    # ORGANIZATIONS
    #==========================================================================
    - name: Create organization
      awx.awx.organization:
        name: "{{ org_name | default('Default') }}"
        description: "Primary organization for automation"
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: "{{ validate_certs }}"

    #==========================================================================
    # TEAMS
    #==========================================================================
    - name: Create teams
      awx.awx.team:
        name: "{{ item.name }}"
        description: "{{ item.description }}"
        organization: "{{ org_name | default('Default') }}"
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: "{{ validate_certs }}"
      loop:
        - { name: "Administrators", description: "Platform administrators" }
        - { name: "Operators", description: "Operations team" }
        - { name: "Developers", description: "Automation developers" }
        - { name: "Auditors", description: "Read-only access for audits" }

    #==========================================================================
    # CREDENTIALS
    #==========================================================================
    - name: Create machine credential for Linux servers
      awx.awx.credential:
        name: "linux-ssh-key"
        organization: "{{ org_name | default('Default') }}"
        credential_type: Machine
        inputs:
          username: "{{ ssh_username | default('ansible') }}"
          ssh_key_data: "{{ lookup('env', 'SSH_PRIVATE_KEY') }}"
          become_method: sudo
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: "{{ validate_certs }}"
      no_log: true

    - name: Create machine credential for Windows servers
      awx.awx.credential:
        name: "windows-winrm"
        organization: "{{ org_name | default('Default') }}"
        credential_type: Machine
        inputs:
          username: "{{ winrm_username | default('ansible') }}"
          password: "{{ lookup('env', 'WINRM_PASSWORD') }}"
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: "{{ validate_certs }}"
      no_log: true

    - name: Create source control credential
      awx.awx.credential:
        name: "git-credentials"
        organization: "{{ org_name | default('Default') }}"
        credential_type: "Source Control"
        inputs:
          username: "git"
          ssh_key_data: "{{ lookup('env', 'GIT_SSH_KEY') }}"
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: "{{ validate_certs }}"
      no_log: true

    - name: Create Vault credential lookup
      awx.awx.credential:
        name: "hashicorp-vault"
        organization: "{{ org_name | default('Default') }}"
        credential_type: "HashiCorp Vault Secret Lookup"
        inputs:
          url: "{{ vault_url }}"
          role_id: "{{ lookup('env', 'VAULT_ROLE_ID') }}"
          secret_id: "{{ lookup('env', 'VAULT_SECRET_ID') }}"
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: "{{ validate_certs }}"
      when: vault_enabled | default(false)
      no_log: true

    #==========================================================================
    # PROJECTS
    #==========================================================================
    - name: Create main automation project
      awx.awx.project:
        name: "Automation Playbooks"
        organization: "{{ org_name | default('Default') }}"
        scm_type: git
        scm_url: "{{ git_repo_url }}"
        scm_branch: main
        scm_clean: true
        scm_update_on_launch: true
        credential: "git-credentials"
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: "{{ validate_certs }}"

    - name: Update project
      awx.awx.project_update:
        name: "Automation Playbooks"
        wait: true
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: "{{ validate_certs }}"

    #==========================================================================
    # INVENTORIES
    #==========================================================================
    - name: Create static inventory
      awx.awx.inventory:
        name: "{{ item.name }}"
        description: "{{ item.description }}"
        organization: "{{ org_name | default('Default') }}"
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: "{{ validate_certs }}"
      loop:
        - { name: "Linux Servers", description: "Linux server inventory" }
        - { name: "Windows Servers", description: "Windows server inventory" }
        - { name: "Network Devices", description: "Network device inventory" }

    - name: Create inventory source for dynamic inventory
      awx.awx.inventory_source:
        name: "AWS EC2"
        description: "Dynamic inventory from AWS"
        inventory: "Linux Servers"
        source: ec2
        source_vars:
          regions:
            - us-east-1
            - us-west-2
          keyed_groups:
            - key: tags['Environment']
              prefix: env
        update_on_launch: true
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: "{{ validate_certs }}"
      when: aws_dynamic_inventory | default(false)

    #==========================================================================
    # JOB TEMPLATES
    #==========================================================================
    - name: Create job templates
      awx.awx.job_template:
        name: "{{ item.name }}"
        description: "{{ item.description }}"
        organization: "{{ org_name | default('Default') }}"
        project: "Automation Playbooks"
        playbook: "{{ item.playbook }}"
        inventory: "{{ item.inventory }}"
        credentials:
          - "{{ item.credential }}"
        job_type: run
        ask_limit_on_launch: true
        ask_variables_on_launch: true
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: "{{ validate_certs }}"
      loop:
        - { name: "Linux Patching", description: "Patch Linux servers", playbook: "playbooks/linux-patching.yml", inventory: "Linux Servers", credential: "linux-ssh-key" }
        - { name: "Windows Patching", description: "Patch Windows servers", playbook: "playbooks/windows-patching.yml", inventory: "Windows Servers", credential: "windows-winrm" }
        - { name: "Network Backup", description: "Backup network device configs", playbook: "playbooks/network-backup.yml", inventory: "Network Devices", credential: "linux-ssh-key" }
        - { name: "Compliance Check", description: "Run compliance validation", playbook: "playbooks/compliance-check.yml", inventory: "Linux Servers", credential: "linux-ssh-key" }

    #==========================================================================
    # SCHEDULES
    #==========================================================================
    - name: Create patching schedule
      awx.awx.schedule:
        name: "Weekly Linux Patching"
        unified_job_template: "Linux Patching"
        rrule: "DTSTART:20240101T020000Z RRULE:FREQ=WEEKLY;BYDAY=SU"
        enabled: true
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: "{{ validate_certs }}"
      when: enable_schedules | default(true)

    #==========================================================================
    # NOTIFICATIONS
    #==========================================================================
    - name: Create PagerDuty notification
      awx.awx.notification_template:
        name: "PagerDuty Alerts"
        organization: "{{ org_name | default('Default') }}"
        notification_type: pagerduty
        notification_configuration:
          subdomain: "{{ pagerduty_subdomain | default('company') }}"
          service_key: "{{ lookup('env', 'PAGERDUTY_SERVICE_KEY') }}"
          client_name: "Ansible Automation Platform"
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: "{{ validate_certs }}"
      when: pagerduty_enabled | default(false)
      no_log: true

    #==========================================================================
    # SETTINGS
    #==========================================================================
    - name: Configure logging
      awx.awx.settings:
        settings:
          LOG_AGGREGATOR_HOST: "{{ log_aggregator_host }}"
          LOG_AGGREGATOR_PORT: "{{ log_aggregator_port }}"
          LOG_AGGREGATOR_TYPE: "{{ log_aggregator_type | default('splunk') }}"
          LOG_AGGREGATOR_ENABLED: true
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: "{{ validate_certs }}"
      when: log_aggregator_enabled | default(false)

    - name: Configure LDAP authentication
      awx.awx.settings:
        settings:
          AUTH_LDAP_SERVER_URI: "{{ ldap_url }}"
          AUTH_LDAP_BIND_DN: "{{ ldap_bind_dn }}"
          AUTH_LDAP_BIND_PASSWORD: "{{ lookup('env', 'LDAP_BIND_PASSWORD') }}"
          AUTH_LDAP_USER_SEARCH:
            - "{{ ldap_user_search }}"
            - SCOPE_SUBTREE
            - "(uid=%(user)s)"
          AUTH_LDAP_GROUP_SEARCH:
            - "{{ ldap_group_search }}"
            - SCOPE_SUBTREE
            - "(objectClass=groupOfNames)"
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: "{{ validate_certs }}"
      when: ldap_enabled | default(false)
      no_log: true

    #==========================================================================
    # SUMMARY
    #==========================================================================
    - name: Display configuration summary
      ansible.builtin.debug:
        msg: |
          Controller configuration complete:
          - Organization: {{ org_name | default('Default') }}
          - Teams: 4 created
          - Credentials: 4 configured
          - Projects: 1 synced
          - Inventories: 3 created
          - Job Templates: 4 created
          - LDAP: {{ ldap_enabled | default(false) }}
          - Logging: {{ log_aggregator_enabled | default(false) }}
