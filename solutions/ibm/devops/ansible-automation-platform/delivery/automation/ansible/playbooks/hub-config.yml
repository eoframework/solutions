---
# Ansible Automation Hub Configuration
# Configures Private Automation Hub with collections and execution environments
#
# Usage:
#   ansible-playbook -i inventory/prod playbooks/hub-config.yml
#
# Prerequisites:
#   - AAP Hub deployed and accessible
#   - Hub admin credentials available
#   - ansible.hub collection installed

- name: Configure Automation Hub
  hosts: localhost
  gather_facts: false
  connection: local

  vars_files:
    - "{{ playbook_dir }}/../inventory/{{ env | default('prod') }}/group_vars/all.yml"

  vars:
    hub_host: "{{ automation_hub_url }}"
    hub_username: "{{ lookup('env', 'HUB_USERNAME') | default('admin') }}"
    hub_password: "{{ lookup('env', 'HUB_PASSWORD') }}"
    validate_certs: false

  tasks:
    #==========================================================================
    # NAMESPACES
    #==========================================================================
    - name: Create namespaces for collections
      ansible.builtin.uri:
        url: "{{ hub_host }}/api/galaxy/v3/namespaces/"
        method: POST
        user: "{{ hub_username }}"
        password: "{{ hub_password }}"
        force_basic_auth: true
        validate_certs: "{{ validate_certs }}"
        body_format: json
        body:
          name: "{{ item }}"
          description: "Namespace for {{ item }} collections"
        status_code: [201, 409]  # 409 if already exists
      loop:
        - company
        - internal

    #==========================================================================
    # REMOTE REPOSITORIES
    #==========================================================================
    - name: Configure Red Hat Certified collection remote
      ansible.builtin.uri:
        url: "{{ hub_host }}/api/galaxy/content/rh-certified/v3/sync/config/"
        method: PUT
        user: "{{ hub_username }}"
        password: "{{ hub_password }}"
        force_basic_auth: true
        validate_certs: "{{ validate_certs }}"
        body_format: json
        body:
          url: "https://console.redhat.com/api/automation-hub/"
          auth_url: "https://sso.redhat.com/auth/realms/redhat-external/protocol/openid-connect/token"
          token: "{{ lookup('env', 'RH_AUTOMATION_HUB_TOKEN') }}"
        status_code: [200, 204]
      no_log: true

    - name: Configure Community collection remote
      ansible.builtin.uri:
        url: "{{ hub_host }}/api/galaxy/content/community/v3/sync/config/"
        method: PUT
        user: "{{ hub_username }}"
        password: "{{ hub_password }}"
        force_basic_auth: true
        validate_certs: "{{ validate_certs }}"
        body_format: json
        body:
          url: "https://galaxy.ansible.com/api/"
          requirements_file: |
            collections:
              - name: community.general
              - name: community.network
              - name: community.windows
              - name: community.vmware
        status_code: [200, 204]

    #==========================================================================
    # SYNC COLLECTIONS
    #==========================================================================
    - name: Sync Red Hat Certified collections
      ansible.builtin.uri:
        url: "{{ hub_host }}/api/galaxy/content/rh-certified/v3/sync/"
        method: POST
        user: "{{ hub_username }}"
        password: "{{ hub_password }}"
        force_basic_auth: true
        validate_certs: "{{ validate_certs }}"
        status_code: [202]
      register: sync_certified

    - name: Sync Community collections
      ansible.builtin.uri:
        url: "{{ hub_host }}/api/galaxy/content/community/v3/sync/"
        method: POST
        user: "{{ hub_username }}"
        password: "{{ hub_password }}"
        force_basic_auth: true
        validate_certs: "{{ validate_certs }}"
        status_code: [202]
      register: sync_community

    #==========================================================================
    # EXECUTION ENVIRONMENTS
    #==========================================================================
    - name: Add execution environment registry
      ansible.builtin.uri:
        url: "{{ hub_host }}/api/galaxy/_ui/v1/execution-environments/registries/"
        method: POST
        user: "{{ hub_username }}"
        password: "{{ hub_password }}"
        force_basic_auth: true
        validate_certs: "{{ validate_certs }}"
        body_format: json
        body:
          name: "Red Hat Registry"
          url: "registry.redhat.io"
        status_code: [201, 409]

    - name: Create execution environment remotes
      ansible.builtin.uri:
        url: "{{ hub_host }}/api/galaxy/_ui/v1/execution-environments/remotes/"
        method: POST
        user: "{{ hub_username }}"
        password: "{{ hub_password }}"
        force_basic_auth: true
        validate_certs: "{{ validate_certs }}"
        body_format: json
        body:
          name: "{{ item.name }}"
          upstream_name: "{{ item.upstream }}"
          registry: "Red Hat Registry"
        status_code: [201, 409]
      loop:
        - { name: "EE Minimal", upstream: "ansible-automation-platform/ee-minimal-rhel8" }
        - { name: "EE Supported", upstream: "ansible-automation-platform/ee-supported-rhel8" }
        - { name: "EE 29", upstream: "ansible-automation-platform/ee-29-rhel8" }

    #==========================================================================
    # GROUPS AND PERMISSIONS
    #==========================================================================
    - name: Create groups
      ansible.builtin.uri:
        url: "{{ hub_host }}/api/galaxy/_ui/v1/groups/"
        method: POST
        user: "{{ hub_username }}"
        password: "{{ hub_password }}"
        force_basic_auth: true
        validate_certs: "{{ validate_certs }}"
        body_format: json
        body:
          name: "{{ item }}"
        status_code: [201, 409]
      loop:
        - "Content Publishers"
        - "Content Consumers"
        - "EE Publishers"

    #==========================================================================
    # SUMMARY
    #==========================================================================
    - name: Display Hub configuration summary
      ansible.builtin.debug:
        msg: |
          Automation Hub configuration complete:
          - Namespaces: company, internal
          - Remote repositories: Red Hat Certified, Community
          - Execution environments: EE Minimal, EE Supported, EE 29
          - Groups: Content Publishers, Content Consumers, EE Publishers
          - Sync status: Initiated for certified and community collections
