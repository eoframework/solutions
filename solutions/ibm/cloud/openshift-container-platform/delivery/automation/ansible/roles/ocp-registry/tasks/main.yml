---
#==============================================================================
# OCP Registry Role - Main Tasks
#==============================================================================
# Configures Quay or internal registry
#==============================================================================

- name: Configure internal registry
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: imageregistry.operator.openshift.io/v1
      kind: Config
      metadata:
        name: cluster
      spec:
        managementState: Managed
        storage:
          pvc:
            claim: ""
        replicas: "{{ registry.internal_registry_replicas | default(2) }}"
  when: not registry.quay_enabled | default(false)

- name: Create quay-enterprise namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: quay-enterprise
  when: registry.quay_enabled | default(false)

- name: Install Quay Operator
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: Subscription
      metadata:
        name: quay-operator
        namespace: openshift-operators
      spec:
        channel: stable-3.10
        installPlanApproval: Automatic
        name: quay-operator
        source: redhat-operators
        sourceNamespace: openshift-marketplace
  when: registry.quay_enabled | default(false)

- name: Wait for Quay operator to be ready
  kubernetes.core.k8s_info:
    api_version: operators.coreos.com/v1alpha1
    kind: ClusterServiceVersion
    namespace: openshift-operators
    label_selectors:
      - operators.coreos.com/quay-operator.openshift-operators
  register: quay_csv
  until: >
    quay_csv.resources | length > 0 and
    quay_csv.resources[0].status.phase | default('') == 'Succeeded'
  retries: 30
  delay: 30
  when: registry.quay_enabled | default(false)

- name: Create QuayRegistry instance
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: quay.redhat.com/v1
      kind: QuayRegistry
      metadata:
        name: registry
        namespace: quay-enterprise
      spec:
        configBundleSecret: quay-config-bundle
        components:
          - kind: clair
            managed: true
          - kind: postgres
            managed: true
          - kind: objectstorage
            managed: true
          - kind: redis
            managed: true
          - kind: horizontalpodautoscaler
            managed: true
          - kind: route
            managed: true
          - kind: mirror
            managed: true
          - kind: monitoring
            managed: true
          - kind: tls
            managed: true
          - kind: quay
            managed: true
          - kind: clairpostgres
            managed: true
  when: registry.quay_enabled | default(false)
