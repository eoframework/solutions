---
# OpenShift Operator Installation
# Installs and configures operators from OperatorHub
#
# Usage:
#   ansible-playbook -i inventory/prod playbooks/operators-install.yml
#
# Operators installed:
#   - OpenShift Logging (EFK stack)
#   - OpenShift Data Foundation (Ceph storage)
#   - OpenShift Pipelines (Tekton)
#   - OpenShift GitOps (ArgoCD)
#   - OpenShift Service Mesh (Istio)
#   - Red Hat Quay (Container registry)

- name: Install OpenShift Operators
  hosts: localhost
  gather_facts: false
  connection: local

  vars_files:
    - "{{ playbook_dir }}/../inventory/{{ env | default('prod') }}/group_vars/all.yml"

  tasks:
    #==========================================================================
    # OPERATOR NAMESPACES
    #==========================================================================
    - name: Create operator namespaces
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ item }}"
      loop:
        - openshift-logging
        - openshift-operators-redhat
        - openshift-pipelines
        - openshift-gitops
        - openshift-distributed-tracing
        - quay-enterprise

    #==========================================================================
    # LOGGING OPERATOR (EFK)
    #==========================================================================
    - name: Install Elasticsearch Operator
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: operators.coreos.com/v1alpha1
          kind: Subscription
          metadata:
            name: elasticsearch-operator
            namespace: openshift-operators-redhat
          spec:
            channel: stable
            installPlanApproval: Automatic
            name: elasticsearch-operator
            source: redhat-operators
            sourceNamespace: openshift-marketplace
      when: efk_enabled | default(true)

    - name: Install Cluster Logging Operator
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: operators.coreos.com/v1alpha1
          kind: Subscription
          metadata:
            name: cluster-logging
            namespace: openshift-logging
          spec:
            channel: stable
            installPlanApproval: Automatic
            name: cluster-logging
            source: redhat-operators
            sourceNamespace: openshift-marketplace
      when: efk_enabled | default(true)

    - name: Wait for Logging operator
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        namespace: openshift-logging
        name: cluster-logging-operator
      register: logging_deployment
      until: logging_deployment.resources | length > 0 and
             logging_deployment.resources[0].status.availableReplicas | default(0) >= 1
      retries: 30
      delay: 10
      when: efk_enabled | default(true)

    - name: Configure ClusterLogging instance
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: logging.openshift.io/v1
          kind: ClusterLogging
          metadata:
            name: instance
            namespace: openshift-logging
          spec:
            managementState: Managed
            logStore:
              type: elasticsearch
              retentionPolicy:
                application:
                  maxAge: "{{ efk_log_retention | default('7d') }}"
                infra:
                  maxAge: "{{ efk_log_retention | default('7d') }}"
                audit:
                  maxAge: "{{ efk_log_retention | default('7d') }}"
              elasticsearch:
                nodeCount: 3
                storage:
                  storageClassName: "{{ storage_class_block }}"
                  size: "{{ elasticsearch_storage | default('500Gi') }}"
                redundancyPolicy: SingleRedundancy
            visualization:
              type: kibana
              kibana:
                replicas: 1
            collection:
              logs:
                type: fluentd
                fluentd: {}
      when: efk_enabled | default(true)

    #==========================================================================
    # PIPELINES OPERATOR (TEKTON)
    #==========================================================================
    - name: Install OpenShift Pipelines Operator
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: operators.coreos.com/v1alpha1
          kind: Subscription
          metadata:
            name: openshift-pipelines-operator
            namespace: openshift-operators
          spec:
            channel: latest
            installPlanApproval: Automatic
            name: openshift-pipelines-operator-rh
            source: redhat-operators
            sourceNamespace: openshift-marketplace
      when: tekton_enabled | default(true)

    #==========================================================================
    # GITOPS OPERATOR (ARGOCD)
    #==========================================================================
    - name: Install OpenShift GitOps Operator
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: operators.coreos.com/v1alpha1
          kind: Subscription
          metadata:
            name: openshift-gitops-operator
            namespace: openshift-operators
          spec:
            channel: latest
            installPlanApproval: Automatic
            name: openshift-gitops-operator
            source: redhat-operators
            sourceNamespace: openshift-marketplace
      when: argocd_enabled | default(true)

    - name: Wait for GitOps operator
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        namespace: openshift-gitops
        name: openshift-gitops-server
      register: gitops_deployment
      until: gitops_deployment.resources | length > 0 and
             gitops_deployment.resources[0].status.availableReplicas | default(0) >= 1
      retries: 30
      delay: 10
      when: argocd_enabled | default(true)

    #==========================================================================
    # SERVICE MESH (ISTIO)
    #==========================================================================
    - name: Install Service Mesh Operators
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: operators.coreos.com/v1alpha1
          kind: Subscription
          metadata:
            name: "{{ item.name }}"
            namespace: openshift-operators
          spec:
            channel: stable
            installPlanApproval: Automatic
            name: "{{ item.package }}"
            source: redhat-operators
            sourceNamespace: openshift-marketplace
      loop:
        - { name: jaeger-product, package: jaeger-product }
        - { name: kiali-ossm, package: kiali-ossm }
        - { name: servicemeshoperator, package: servicemeshoperator }
      when: istio_enabled | default(true)

    #==========================================================================
    # QUAY REGISTRY
    #==========================================================================
    - name: Install Quay Operator
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: operators.coreos.com/v1alpha1
          kind: Subscription
          metadata:
            name: quay-operator
            namespace: openshift-operators
          spec:
            channel: stable-3.9
            installPlanApproval: Automatic
            name: quay-operator
            source: redhat-operators
            sourceNamespace: openshift-marketplace
      when: quay_enabled | default(false)

    - name: Create Quay Registry instance
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: quay.redhat.com/v1
          kind: QuayRegistry
          metadata:
            name: registry
            namespace: quay-enterprise
          spec:
            components:
              - kind: clair
                managed: true
              - kind: postgres
                managed: true
              - kind: objectstorage
                managed: true
              - kind: redis
                managed: true
              - kind: horizontalpodautoscaler
                managed: true
              - kind: route
                managed: true
              - kind: mirror
                managed: true
              - kind: monitoring
                managed: true
              - kind: tls
                managed: true
              - kind: quay
                managed: true
              - kind: clairpostgres
                managed: true
      when: quay_enabled | default(false)

    #==========================================================================
    # SUMMARY
    #==========================================================================
    - name: Display installed operators
      ansible.builtin.debug:
        msg: |
          Operators installed:
          - Logging (EFK): {{ efk_enabled | default(true) }}
          - Pipelines (Tekton): {{ tekton_enabled | default(true) }}
          - GitOps (ArgoCD): {{ argocd_enabled | default(true) }}
          - Service Mesh (Istio): {{ istio_enabled | default(false) }}
          - Quay Registry: {{ quay_enabled | default(false) }}
