---
# OpenShift Security Configuration
# Configures security policies, RBAC, and compliance settings
#
# Usage:
#   ansible-playbook -i inventory/prod playbooks/security-config.yml
#
# Security features configured:
#   - RBAC roles and bindings
#   - Network policies
#   - Pod security policies
#   - Audit logging
#   - Certificate management

- name: Configure OpenShift Security
  hosts: localhost
  gather_facts: false
  connection: local

  vars_files:
    - "{{ playbook_dir }}/../inventory/{{ env | default('prod') }}/group_vars/all.yml"

  tasks:
    #==========================================================================
    # RBAC CONFIGURATION
    #==========================================================================
    - name: Create cluster-admin group binding for LDAP admins
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: ldap-cluster-admins
          subjects:
            - kind: Group
              name: "{{ ldap_admin_group | default('ocp-admins') }}"
              apiGroup: rbac.authorization.k8s.io
          roleRef:
            kind: ClusterRole
            name: cluster-admin
            apiGroup: rbac.authorization.k8s.io
      when: ldap_enabled | default(true)

    - name: Create developer role binding for LDAP developers
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: ldap-developers
          subjects:
            - kind: Group
              name: "{{ ldap_developer_group | default('ocp-developers') }}"
              apiGroup: rbac.authorization.k8s.io
          roleRef:
            kind: ClusterRole
            name: edit
            apiGroup: rbac.authorization.k8s.io
      when: ldap_enabled | default(true)

    #==========================================================================
    # NETWORK POLICIES
    #==========================================================================
    - name: Create default deny network policy template
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: NetworkPolicy
          metadata:
            name: default-deny-ingress
            namespace: default
          spec:
            podSelector: {}
            policyTypes:
              - Ingress

    - name: Create allow same namespace policy
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: NetworkPolicy
          metadata:
            name: allow-same-namespace
            namespace: default
          spec:
            podSelector: {}
            policyTypes:
              - Ingress
            ingress:
              - from:
                  - podSelector: {}

    #==========================================================================
    # POD SECURITY
    #==========================================================================
    - name: Configure pod security admission
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ item }}"
            labels:
              pod-security.kubernetes.io/enforce: restricted
              pod-security.kubernetes.io/audit: restricted
              pod-security.kubernetes.io/warn: restricted
      loop: "{{ restricted_namespaces | default(['production']) }}"
      when: enforce_pod_security | default(false)

    #==========================================================================
    # AUDIT LOGGING
    #==========================================================================
    - name: Configure audit policy
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: config.openshift.io/v1
          kind: APIServer
          metadata:
            name: cluster
          spec:
            audit:
              profile: Default

    #==========================================================================
    # SERVICE MESH SECURITY (MTLS)
    #==========================================================================
    - name: Configure Service Mesh Control Plane with mTLS
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: maistra.io/v2
          kind: ServiceMeshControlPlane
          metadata:
            name: basic
            namespace: istio-system
          spec:
            version: v2.4
            security:
              dataPlane:
                mtls: true
              controlPlane:
                mtls: true
            tracing:
              type: Jaeger
            addons:
              jaeger:
                install:
                  storage:
                    type: Memory
              kiali:
                enabled: true
              grafana:
                enabled: true
      when: istio_enabled | default(false) and istio_mtls_mode == 'STRICT'

    - name: Create PeerAuthentication for strict mTLS
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: security.istio.io/v1beta1
          kind: PeerAuthentication
          metadata:
            name: default
            namespace: istio-system
          spec:
            mtls:
              mode: "{{ istio_mtls_mode | default('STRICT') }}"
      when: istio_enabled | default(false)

    #==========================================================================
    # ETCD ENCRYPTION
    #==========================================================================
    - name: Enable etcd encryption for secrets
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: config.openshift.io/v1
          kind: APIServer
          metadata:
            name: cluster
          spec:
            encryption:
              type: aescbc
      when: encrypt_etcd | default(true)

    - name: Wait for encryption to complete
      kubernetes.core.k8s_info:
        api_version: config.openshift.io/v1
        kind: APIServer
        name: cluster
      register: apiserver
      until: >
        apiserver.resources[0].status.conditions |
        selectattr('type', 'equalto', 'Encrypted') |
        selectattr('status', 'equalto', 'True') |
        list | length > 0
      retries: 60
      delay: 30
      when: encrypt_etcd | default(true)

    #==========================================================================
    # COMPLIANCE OPERATOR
    #==========================================================================
    - name: Install Compliance Operator
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: operators.coreos.com/v1alpha1
          kind: Subscription
          metadata:
            name: compliance-operator
            namespace: openshift-compliance
          spec:
            channel: stable
            installPlanApproval: Automatic
            name: compliance-operator
            source: redhat-operators
            sourceNamespace: openshift-marketplace
      when: compliance_operator_enabled | default(false)

    #==========================================================================
    # SUMMARY
    #==========================================================================
    - name: Display security configuration
      ansible.builtin.debug:
        msg: |
          Security configuration applied:
          - LDAP RBAC bindings: {{ ldap_enabled | default(true) }}
          - Network policies: Created
          - Pod security admission: {{ enforce_pod_security | default(false) }}
          - Audit logging: Enabled
          - etcd encryption: {{ encrypt_etcd | default(true) }}
          - Service Mesh mTLS: {{ istio_mtls_mode | default('N/A') }}
          - Compliance Operator: {{ compliance_operator_enabled | default(false) }}
